<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªß Th√†nh Chi·∫øn Thu·∫≠t: V√πng ƒê·∫•t Ch·∫øt (Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        canvas { display: block; background: #4ade80; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .top-bar { 
            display: flex; justify-content: space-between; padding: 10px 20px; 
            background: rgba(15, 23, 42, 0.85); color: white; pointer-events: auto;
            border-bottom: 2px solid #fbbf24; backdrop-filter: blur(4px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .stat-box { display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 1.1rem; }
        
        .menu-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            pointer-events: auto; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .menu-container.collapsed { transform: translateX(-50%) translateY(110px); }

        .toggle-btn {
            background: #334155; color: #cbd5e1; border: 2px solid #475569;
            padding: 4px 20px; border-radius: 20px 20px 0 0; cursor: pointer;
            font-size: 0.8rem; font-weight: bold; text-transform: uppercase;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
        }
        .toggle-btn:hover { background: #475569; color: white; }

        .build-menu {
            display: flex; gap: 10px; padding: 12px;
            background: rgba(30, 41, 59, 0.95); border-radius: 16px; 
            border: 2px solid #475569; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        
        .tower-btn {
            position: relative; width: 70px; height: 70px;
            background: #1e293b; border: 2px solid #334155; border-radius: 10px;
            cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #94a3b8; font-size: 0.7rem; text-align: center;
        }
        .tower-btn:hover { transform: translateY(-3px); border-color: #fbbf24; background: #334155; color: white; }
        .tower-btn.selected { border-color: #facc15; box-shadow: 0 0 10px rgba(250, 204, 21, 0.4); transform: translateY(-5px); background: #0f172a; color: white; }
        .tower-btn.disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; transform: none; }
        .tower-icon { font-size: 1.6rem; margin-bottom: 2px; }
        .cost { color: #fbbf24; font-weight: bold; }

        #tower-inspector {
            position: absolute; bottom: 140px; right: 20px; width: 280px;
            background: rgba(15, 23, 42, 0.95); border: 2px solid #64748b; border-radius: 12px;
            padding: 15px; color: white; pointer-events: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; animation: slideIn 0.2s ease-out;
            backdrop-filter: blur(5px);
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        .inspector-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; padding-bottom: 8px; margin-bottom: 10px; }
        .inspector-title { font-size: 1.2rem; font-weight: bold; color: #facc15; }
        .close-btn { background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 1.2rem; }
        .close-btn:hover { color: white; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9rem; color: #cbd5e1; }
        .stat-val { font-weight: bold; color: white; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .action-btn {
            padding: 8px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; transition: 0.2s;
        }
        .btn-upgrade { background: #15803d; color: #dcfce7; } .btn-upgrade:hover { background: #166534; }
        .btn-sell { background: #991b1b; color: #fee2e2; } .btn-sell:hover { background: #7f1d1d; }

        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; z-index: 100; pointer-events: auto;
        }
        .btn-primary {
            padding: 12px 40px; background: linear-gradient(to bottom, #ea580c, #c2410c); color: white;
            border: none; border-radius: 8px; font-size: 1.4rem; cursor: pointer;
            font-weight: bold; margin-top: 20px; transition: 0.2s;
            box-shadow: 0 4px 0 #7c2d12; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-primary:active { transform: translateY(4px); box-shadow: none; }
        
        .floating-text {
            position: absolute; pointer-events: none; 
            font-weight: 900; text-shadow: 1px 1px 0 #000; font-family: monospace;
            animation: floatUp 1s ease-out forwards;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="stat-box"><span style="color:#ef4444">‚ù§</span> <span id="lives">20</span></div>
            <div class="stat-box"><span style="color:#fbbf24">üí∞</span> <span id="gold">450</span></div>
            <div class="stat-box">üåä <span id="wave">1</span></div>
            <div class="stat-box" style="font-size: 0.9rem; color: #94a3b8; min-width: 100px; text-align: right;" id="wave-timer">Chu·∫©n b·ªã...</div>
        </div>

        <div id="tower-inspector">
            <div class="inspector-header">
                <span class="inspector-title" id="insp-name">Th√°p</span>
                <button class="close-btn" onclick="closeInspector()">‚úï</button>
            </div>
            <div class="stat-row"><span>S√°t th∆∞∆°ng:</span> <span class="stat-val" id="insp-dmg">0</span></div>
            <div class="stat-row"><span>T·ªëc ƒë·ªô:</span> <span class="stat-val" id="insp-spd">0s</span></div>
            <div class="stat-row"><span>T·∫ßm b·∫Øn:</span> <span class="stat-val" id="insp-rng">0</span></div>
            
            <div class="action-grid">
                <button class="action-btn btn-upgrade" onclick="upgradeSelectedTower()" id="btn-upgrade">
                    <span>N√ÇNG C·∫§P</span>
                    <span style="font-size: 0.9rem" id="upgrade-cost">100$</span>
                </button>
                <button class="action-btn btn-sell" onclick="sellSelectedTower()">
                    <span>B√ÅN</span>
                    <span style="font-size: 0.9rem" id="sell-price">25$</span>
                </button>
            </div>
        </div>

        <div class="menu-container" id="menu-container">
            <div class="toggle-btn" onclick="toggleMenu()">‚ñº Menu X√¢y D·ª±ng ‚ñº</div>
            <div class="build-menu">
                <div class="tower-btn" onclick="selectTower('archer')" id="btn-archer">
                    <div class="tower-icon">üèπ</div> <div>Cung</div> <div class="cost">50$</div>
                </div>
                <div class="tower-btn" onclick="selectTower('cannon')" id="btn-cannon">
                    <div class="tower-icon">üí£</div> <div>Ph√°o</div> <div class="cost">100$</div>
                </div>
                <div class="tower-btn" onclick="selectTower('mage')" id="btn-mage">
                    <div class="tower-icon">üßô‚Äç‚ôÇÔ∏è</div> <div>Ph√©p</div> <div class="cost">150$</div>
                </div>
                <div class="tower-btn" onclick="selectTower('tesla')" id="btn-tesla">
                    <div class="tower-icon">‚ö°</div> <div>ƒêi·ªán</div> <div class="cost">250$</div>
                </div>
                <div class="tower-btn" onclick="selectSoldier()" id="btn-soldier" style="border-color: #3b82f6;">
                    <div class="tower-icon">üõ°Ô∏è</div> <div>L√≠nh</div> <div class="cost" style="color:#60a5fa">Free</div>
                </div>
            </div>
        </div>
        <div id="floating-text-container"></div>
    </div>

    <div id="start-screen" class="modal">
        <h1 class="text-6xl font-black text-yellow-400 mb-2" style="text-shadow: 4px 4px 0 #7c2d12">V√ôNG ƒê·∫§T CH·∫æT</h1>
        <p class="text-gray-400 mb-8 tracking-widest uppercase text-sm">Game Th·ªß Th√†nh Chi·∫øn Thu·∫≠t Final</p>
        <ul class="text-left space-y-2 text-gray-300 mb-8 bg-gray-800 p-6 rounded-lg border border-gray-700">
            <li>üñ±Ô∏è <b>Click v√†o tr·ª•</b> ƒë·ªÉ N√¢ng c·∫•p ho·∫∑c B√°n.</li>
            <li>‚ñº <b>Menu</b> c√≥ th·ªÉ thu g·ªçn ƒë·ªÉ nh√¨n ƒë∆∞·ªùng r√µ h∆°n.</li>
            <li>ü©∏ Qu√°i ch·∫øt ƒë·ªÉ l·∫°i v·ªát m√°u.</li>
            <li>üëπ H√¨nh ·∫£nh qu√°i v·∫≠t v√† th√°p ƒë√£ ƒë∆∞·ª£c ph·ª•c h·ªìi nguy√™n b·∫£n!</li>
        </ul>
        <button class="btn-primary" onclick="startGame()">V√†o Tr·∫≠n</button>
    </div>

    <div id="game-over-screen" class="modal" style="display: none;">
        <h1 class="text-6xl font-bold text-red-500 mb-4">TH·∫§T TH·ª¶!</h1>
        <p class="text-2xl mb-6">S·ªë ƒë·ª£t tr·ª• ƒë∆∞·ª£c: <span id="final-wave" class="text-yellow-400 font-bold">0</span></p>
        <button class="btn-primary" onclick="location.reload()">Ch∆°i L·∫°i</button>
    </div>
</div>

<script>
/** AUDIO SYSTEM **/
const AudioSys = {
    ctx: null,
    init() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
    },
    playTone(freq, type, duration, vol = 0.1) {
        if (!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.connect(gain); gain.connect(this.ctx.destination);
        osc.start(); osc.stop(this.ctx.currentTime + duration);
    },
    playShoot() { this.playTone(600, 'triangle', 0.1, 0.05); },
    playCannon() { this.playTone(80, 'square', 0.4, 0.15); },
    playMagic() { this.playTone(900, 'sine', 0.3, 0.05); },
    playZap() { this.playTone(200, 'sawtooth', 0.1, 0.05); },
    playBuild() { this.playTone(800, 'sine', 0.1, 0.1); },
    playUpgrade() { this.playTone(1000, 'square', 0.2, 0.1); this.playTone(1500, 'sine', 0.4, 0.1); },
    playSell() { this.playTone(300, 'sine', 0.2, 0.1); },
    playExplosion() { this.playTone(100, 'sawtooth', 0.4, 0.2); }
};

/** CONFIG **/
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let mousePos = {x:0, y:0};

const TOWERS_BASE = {
    archer: { name: 'Cung', cost: 50, range: 160, damage: 15, rate: 35 }, 
    cannon: { name: 'Ph√°o', cost: 100, range: 140, damage: 40, rate: 100, aoe: 70 },
    mage:   { name: 'Ph√©p', cost: 150, range: 180, damage: 5, rate: 5, slow: 0.4 }, 
    tesla:  { name: 'ƒêi·ªán', cost: 250, range: 130, damage: 60, rate: 80, stun: 40, multi: 3 }
};

let GAME = {
    width: 0, height: 0, lives: 20, gold: 450, wave: 1,
    active: false, gameOver: false,
    path: [], slots: [], decorations: [], bloodStains: [],
    enemies: [], towers: [], projectiles: [], soldiers: [], particles: [],
    waveTimer: 5, waveDelayTicker: 60, spawnTimer: 0, enemiesToSpawn: [],
    selection: null, selectedTower: null,
    soldierCooldown: 0, soldierMaxCooldown: 12
};

function initMap() {
    GAME.width = window.innerWidth;
    GAME.height = window.innerHeight;
    canvas.width = GAME.width;
    canvas.height = GAME.height;
    const w = GAME.width; const h = GAME.height;
    
    // Zigzag path (Restore style)
    GAME.path = [
        {x: 0, y: h * 0.15}, {x: w * 0.15, y: h * 0.15}, {x: w * 0.15, y: h * 0.5},
        {x: w * 0.35, y: h * 0.5}, {x: w * 0.35, y: h * 0.2}, {x: w * 0.60, y: h * 0.2},
        {x: w * 0.60, y: h * 0.7}, {x: w * 0.40, y: h * 0.7}, {x: w * 0.40, y: h * 0.85},
        {x: w * 0.85, y: h * 0.85}, {x: w * 0.85, y: h * 0.5}, {x: w, y: h * 0.5} 
    ];

    GAME.slots = [];
    for (let i = 0; i < GAME.path.length - 1; i++) {
        let p1 = GAME.path[i]; let p2 = GAME.path[i+1];
        let dist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
        let steps = Math.floor(dist / 70); 
        for (let j = 1; j < steps; j++) {
            let t = j / steps;
            let cx = p1.x + (p2.x - p1.x) * t; let cy = p1.y + (p2.y - p1.y) * t;
            let dx = p2.x - p1.x; let dy = p2.y - p1.y;
            let len = Math.hypot(dx, dy);
            let perpX = -dy / len; let perpY = dx / len;
            let offset = 60;
            addSlot(cx + perpX * offset, cy + perpY * offset);
            addSlot(cx - perpX * offset, cy - perpY * offset);
        }
    }

    GAME.decorations = [];
    for(let k=0; k<40; k++) {
        GAME.decorations.push({
            x: Math.random() * w, y: Math.random() * h,
            r: 5 + Math.random() * 25, type: Math.random() > 0.3 ? 'tree' : 'rock',
            color: Math.random() > 0.3 ? '#166534' : '#64748b'
        });
    }
}

function addSlot(x, y) {
    for (let i = 0; i < GAME.path.length - 1; i++) {
        let p1 = GAME.path[i]; let p2 = GAME.path[i+1];
        if (Math.hypot(x - p1.x, y - p1.y) < 45) return;
        if (Math.hypot(x - p2.x, y - p2.y) < 45) return;
    }
    GAME.slots.push({x: x, y: y, occupied: false, r: 25});
}

/** CLASSES - VISUALS RESTORED **/

class BloodStain {
    constructor(x, y) {
        this.x = x; this.y = y; this.life = 600; this.maxLife = 600;
        this.shape = []; this.r = 10 + Math.random()*15;
        for(let i=0; i<8; i++) {
            let a = (i/8)*Math.PI*2;
            let rOff = this.r*(0.5+Math.random()*0.8);
            this.shape.push({x: Math.cos(a)*rOff, y: Math.sin(a)*rOff});
        }
    }
    draw() {
        if(this.life<=0) return;
        ctx.save(); ctx.translate(this.x, this.y);
        ctx.globalAlpha = (this.life/this.maxLife)*0.6;
        ctx.fillStyle = '#7f1d1d';
        ctx.beginPath(); ctx.moveTo(this.shape[0].x, this.shape[0].y);
        for(let p of this.shape) ctx.lineTo(p.x, p.y);
        ctx.fill(); ctx.restore();
        this.life--;
    }
}

class Enemy {
    constructor(type) {
        this.pathIndex = 0;
        this.x = GAME.path[0].x; this.y = GAME.path[0].y;
        this.type = type;
        this.frozen = 0; this.slowed = 0;
        this.wobble = Math.random() * 10;
        
        // Restore specific stats & colors
        let waveMult = GAME.wave;
        if (type === 'boss') {
            this.hp = 800 + (waveMult * 200);
            this.speed = 0.6; this.r = 30; this.bounty = 100;
        } else if (type === 'swarm') {
            this.hp = 20 + (waveMult * 5);
            this.speed = 3.2; this.r = 10; this.bounty = 8;
        } else if (type === 'tank') {
            this.hp = 180 + (waveMult * 50);
            this.speed = 1.0; this.r = 20; this.bounty = 30;
        } else { // normal
            this.hp = 70 + (waveMult * 25);
            this.speed = 2.0; this.r = 14; this.bounty = 15;
        }
        this.maxHp = this.hp;
    }

    update() {
        this.wobble += 0.2;
        if (this.frozen > 0) { this.frozen--; return; }
        
        let target = GAME.path[this.pathIndex + 1];
        if (!target) return;

        let dx = target.x - this.x; let dy = target.y - this.y;
        let dist = Math.hypot(dx, dy);
        
        let spd = this.speed * (this.slowed > 0 ? 0.6 : 1.0);
        if (this.slowed > 0) this.slowed--;

        let blocked = false;
        for (let s of GAME.soldiers) {
            if (s.target === this && Math.hypot(s.x - this.x, s.y - this.y) < this.r + 15) { blocked = true; break; }
        }
        if (!blocked) { this.x += (dx/dist) * spd; this.y += (dy/dist) * spd; }

        if (dist < spd) {
            this.pathIndex++;
            if (this.pathIndex >= GAME.path.length - 1) this.reachedBase();
        }
    }

    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        let s = 1 + Math.sin(this.wobble)*0.08;
        ctx.scale(s, 1/s);

        // --- RESTORED VISUALS ---
        if (this.type === 'swarm' || this.type === 'fast') {
            // Triangle with spikes (Spider/Bug look)
            ctx.fillStyle = '#991b1b'; // Dark Red
            ctx.beginPath(); ctx.moveTo(0, -this.r); ctx.lineTo(this.r, this.r); ctx.lineTo(-this.r, this.r); ctx.fill();
            // Eyes
            ctx.fillStyle = '#fbbf24'; ctx.beginPath(); ctx.arc(-4, -4, 2, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(4, -4, 2, 0, Math.PI*2); ctx.fill();
            // Spikes
            ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(-this.r, 5); ctx.lineTo(-this.r-5, 0); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(this.r, 5); ctx.lineTo(this.r+5, 0); ctx.stroke();

        } else if (this.type === 'tank') {
            // Stone Golem (Blocky)
            ctx.fillStyle = '#374151'; 
            ctx.beginPath(); ctx.roundRect(-this.r, -this.r, this.r*2, this.r*2, 5); ctx.fill();
            // Big Eye
            ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(0, -5, 6, 0, Math.PI*2); ctx.fill();
            // Cracks
            ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(-10, 10); ctx.lineTo(10, 10); ctx.stroke();

        } else if (this.type === 'boss') {
            // Big Boss (Modified Tank/Normal hybrid)
            ctx.fillStyle = '#581c87'; // Purple
            ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill();
            // Spikes all over
            ctx.fillStyle = '#000';
            for(let i=0; i<6; i++) {
                let a = (i/6)*Math.PI*2;
                ctx.beginPath(); ctx.arc(Math.cos(a)*this.r, Math.sin(a)*this.r, 6, 0, Math.PI*2); ctx.fill();
            }
            ctx.fillStyle = '#fff'; ctx.font='20px Arial'; ctx.fillText('üíÄ', -10, 8);

        } else {
            // Normal (Goblin)
            ctx.fillStyle = '#3f6212'; // Moss Green
            ctx.beginPath(); ctx.arc(0, 0, this.r, 0, Math.PI*2); ctx.fill();
            // Ears
            ctx.beginPath(); ctx.moveTo(-this.r, 0); ctx.lineTo(-this.r-5, -8); ctx.lineTo(-this.r+2, -5); ctx.fill();
            ctx.beginPath(); ctx.moveTo(this.r, 0); ctx.lineTo(this.r+5, -8); ctx.lineTo(this.r-2, -5); ctx.fill();
            // Eyes
            ctx.fillStyle = '#fca5a5'; ctx.beginPath(); ctx.arc(-5, -2, 4, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(5, -2, 4, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();

        // HP Bar
        const pct = Math.max(0, this.hp/this.maxHp);
        const barW = this.r * 2;
        ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fillRect(this.x - barW/2, this.y - this.r - 12, barW, 4);
        ctx.fillStyle = pct > 0.5 ? '#22c55e' : '#ef4444'; ctx.fillRect(this.x - barW/2, this.y - this.r - 12, barW * pct, 4);
        if (this.frozen > 0) ctx.fillText('‚ö°', this.x, this.y-25);
        else if (this.slowed > 0) ctx.fillText('‚ùÑÔ∏è', this.x, this.y-25);
    }

    takeDamage(amt) {
        this.hp -= amt;
        GAME.particles.push(new Particle(this.x, this.y, '#fff', 0.5));
        if (this.hp <= 0) {
            GAME.gold += this.bounty;
            GAME.bloodStains.push(new BloodStain(this.x, this.y));
            updateUI();
            return true;
        }
        return false;
    }

    reachedBase() {
        this.hp = 0; GAME.lives--;
        AudioSys.playExplosion();
        updateUI();
        if (GAME.lives <= 0) endGame();
    }
}

class Tower {
    constructor(x, y, type) {
        this.x = x; this.y = y; this.type = type; this.level = 1;
        const base = TOWERS_BASE[type];
        this.damage = base.damage; this.range = base.range; this.rate = base.rate;
        this.cooldown = 0; this.angle = 0;
        this.baseCost = base.cost; this.totalValue = base.cost;
    }
    upgrade() {
        this.level++; this.totalValue += this.getUpgradeCost();
        this.damage *= 1.4; this.range *= 1.05; if (this.rate > 5) this.rate *= 0.9;
        GAME.particles.push(new Particle(this.x, this.y, '#fbbf24', 3)); AudioSys.playUpgrade();
    }
    getUpgradeCost() { return Math.floor(this.baseCost * Math.pow(1.5, this.level)); }
    getSellPrice() { return Math.floor(this.totalValue * 0.7); }

    update() {
        if (this.cooldown > 0) this.cooldown--;
        let targets = GAME.enemies.filter(e => Math.hypot(e.x - this.x, e.y - this.y) <= this.range);
        if (targets.length === 0) return;
        targets.sort((a,b) => (Math.hypot(a.x-this.x, a.y-this.y) - Math.hypot(b.x-this.x, b.y-this.y)));
        let target = targets[0];
        this.angle = Math.atan2(target.y - this.y, target.x - this.x);

        if (this.cooldown <= 0) {
            this.shoot(target, targets);
            this.cooldown = this.rate;
        }
    }

    shoot(target, allTargets) {
        const stats = TOWERS_BASE[this.type];
        if (this.type === 'archer') {
            GAME.projectiles.push(new Projectile(this.x, this.y, target, 'arrow', this.damage));
            AudioSys.playShoot();
        } else if (this.type === 'cannon') {
            let barrelLen = 20;
            let bx = this.x + Math.cos(this.angle) * barrelLen; let by = this.y + Math.sin(this.angle) * barrelLen;
            GAME.projectiles.push(new Projectile(bx, by, target, 'bomb', this.damage, stats.aoe));
            AudioSys.playCannon();
            GAME.particles.push(new Particle(bx, by, '#9ca3af'));
        } else if (this.type === 'mage') {
            target.takeDamage(this.damage); target.slowed = 40;
            this.laserTarget = {x: target.x, y: target.y, timer: 6};
            AudioSys.playMagic();
        } else if (this.type === 'tesla') {
            let count = 0; this.visualBolts = [];
            for (let t of allTargets) {
                if (count >= stats.multi + Math.floor(this.level/2)) break;
                t.takeDamage(this.damage); t.frozen = stats.stun;
                this.visualBolts.push({x: t.x, y: t.y, timer: 10}); count++;
            }
            AudioSys.playZap();
        }
    }

    draw() {
        ctx.save(); ctx.translate(this.x, this.y);
        if (GAME.selectedTower === this) {
            ctx.beginPath(); ctx.arc(0,0, this.range, 0, Math.PI*2);
            ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fill();
            ctx.strokeStyle = '#fff'; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
        }
        if (this.level > 1) { ctx.fillStyle = '#facc15'; ctx.font = 'bold 10px Arial'; ctx.fillText('Lv.'+this.level, -10, -28); }

        // Common Base
        ctx.fillStyle = '#4b5563'; ctx.beginPath(); ctx.arc(0, 0, 22, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#374151'; ctx.lineWidth = 2; ctx.stroke();

        // --- RESTORED TOWER VISUALS ---
        if (this.type === 'archer') {
            ctx.rotate(this.angle);
            ctx.fillStyle = '#92400e'; ctx.fillRect(-12, -12, 24, 24);
            ctx.strokeStyle = '#fcd34d'; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.arc(5, 0, 20, Math.PI*0.75, Math.PI*1.25); ctx.stroke();
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(25, 0); ctx.lineTo(20, -4); ctx.moveTo(25, 0); ctx.lineTo(20, 4); ctx.stroke();
        } else if (this.type === 'cannon') {
            ctx.rotate(this.angle);
            ctx.fillStyle = '#1f2937'; ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#000'; ctx.fillRect(0, -10, 32, 20);
            ctx.fillStyle = '#374151'; ctx.fillRect(5, -6, 20, 12);
        } else if (this.type === 'mage') {
            ctx.fillStyle = '#6b21a8'; ctx.beginPath(); ctx.moveTo(0, -15); ctx.lineTo(12, 12); ctx.lineTo(-12, 12); ctx.fill();
            ctx.fillStyle = '#a855f7'; ctx.beginPath(); ctx.moveTo(0, -25); ctx.lineTo(8, -10); ctx.lineTo(-8, -10); ctx.fill();
            ctx.rotate(this.angle);
            ctx.strokeStyle = '#818cf8'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(5, 5); ctx.lineTo(18, 10); ctx.stroke();
            ctx.fillStyle = '#38bdf8'; ctx.beginPath(); ctx.arc(20, 11, 4, 0, Math.PI*2); ctx.fill();
        } else if (this.type === 'tesla') {
            ctx.fillStyle = '#334155'; ctx.fillRect(-10, -15, 20, 30);
            ctx.strokeStyle = '#b45309'; ctx.lineWidth = 3;
            ctx.beginPath(); for(let i=-10; i<10; i+=5) { ctx.moveTo(-10, i); ctx.lineTo(10, i); } ctx.stroke();
            ctx.fillStyle = '#0ea5e9'; ctx.shadowBlur = 10; ctx.shadowColor = '#0ea5e9';
            ctx.beginPath(); ctx.arc(0, -18, 10, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;
            ctx.fillStyle = '#fff'; ctx.font = '14px Arial'; ctx.fillText('‚ö°', -6, -13);
        }
        ctx.restore();

        if (this.type === 'mage' && this.laserTarget && this.laserTarget.timer > 0) {
            ctx.strokeStyle = `rgba(168, 85, 247, ${this.laserTarget.timer/6})`; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(this.x, this.y - 20); ctx.lineTo(this.laserTarget.x, this.laserTarget.y); ctx.stroke();
            this.laserTarget.timer--;
        }
        if (this.type === 'tesla' && this.visualBolts) {
            for(let b of this.visualBolts) {
                if(b.timer > 0) {
                    ctx.beginPath(); ctx.moveTo(this.x, this.y-18);
                    let midX = (this.x+b.x)/2 + (Math.random()*40-20); let midY = (this.y+b.y)/2 + (Math.random()*40-20);
                    ctx.lineTo(midX, midY); ctx.lineTo(b.x, b.y);
                    ctx.strokeStyle = '#bae6fd'; ctx.lineWidth = 2; ctx.stroke(); b.timer--;
                }
            }
        }
    }
}

class Projectile {
    constructor(x, y, target, type, dmg, aoe=0) {
        this.x = x; this.y = y; this.target = target;
        this.tx = target.x; this.ty = target.y;
        this.type = type; this.dmg = dmg; this.aoe = aoe;
        this.speed = type === 'arrow' ? 12 : 7; this.active = true;
    }
    update() {
        if (this.target && this.target.hp > 0) { this.tx = this.target.x; this.ty = this.target.y; }
        let dx = this.tx - this.x; let dy = this.ty - this.y;
        let dist = Math.hypot(dx, dy);
        if (dist < this.speed) {
            this.active = false;
            if (this.type === 'bomb') {
                GAME.enemies.forEach(e => { if (Math.hypot(e.x - this.x, e.y - this.y) < this.aoe) e.takeDamage(this.dmg); });
                GAME.particles.push(new Particle(this.x, this.y, '#f97316', 3)); AudioSys.playExplosion();
                ctx.beginPath(); ctx.arc(this.x, this.y, this.aoe, 0, Math.PI*2); ctx.fillStyle='rgba(239,68,68,0.4)'; ctx.fill();
            } else { if(this.target) this.target.takeDamage(this.dmg); }
        } else { this.x += (dx/dist)*this.speed; this.y += (dy/dist)*this.speed; }
    }
    draw() {
        ctx.fillStyle = this.type === 'arrow' ? '#fef08a' : '#000';
        ctx.beginPath(); ctx.arc(this.x, this.y, this.type==='arrow'?3:5, 0, Math.PI*2); ctx.fill();
    }
}

class Soldier {
    constructor(x, y) { this.x = x; this.y = y; this.hp = 120; this.maxHp = 120; this.target = null; this.timer = 0; }
    update() {
        let nearest = GAME.enemies.find(e => Math.hypot(e.x-this.x, e.y-this.y) < 100);
        if (nearest) {
            if (Math.hypot(nearest.x-this.x, nearest.y-this.y) < 25) {
                if (this.timer <= 0) { nearest.takeDamage(8); this.hp -= 3; this.timer = 40; }
            } else { let dx=nearest.x-this.x; let dy=nearest.y-this.y; let d=Math.hypot(dx,dy); this.x+=(dx/d)*1.5; this.y+=(dy/d)*1.5; }
        }
        if(this.timer>0) this.timer--;
    }
    draw() {
        // Restored Soldier Visual
        ctx.fillStyle = '#2563eb'; ctx.beginPath(); ctx.arc(this.x, this.y, 10, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#94a3b8'; ctx.beginPath(); ctx.arc(this.x, this.y, 6, 0, Math.PI*2); ctx.fill(); // Helm
        ctx.fillStyle = '#1e3a8a'; ctx.beginPath(); ctx.ellipse(this.x-8, this.y, 4, 8, 0, 0, Math.PI*2); ctx.fill(); // Shield
        ctx.strokeStyle = '#fbbf24'; ctx.lineWidth=1; ctx.stroke();
        if (this.timer > 20) { ctx.save(); ctx.translate(this.x+8, this.y); ctx.rotate(Math.PI/4); ctx.fillStyle='#e2e8f0'; ctx.fillRect(0,-8,2,16); ctx.restore(); }
        ctx.fillStyle = '#0f0'; ctx.fillRect(this.x-8, this.y-12, 16*(this.hp/this.maxHp), 3);
    }
}

class Particle {
    constructor(x, y, col, size=1) { this.x = x; this.y = y; this.col = col; this.size = size + Math.random()*2; this.vx = (Math.random()-0.5)*5; this.vy = (Math.random()-0.5)*5; this.life = 1.0; }
    update() { this.x+=this.vx; this.y+=this.vy; this.life-=0.05; }
    draw() { ctx.globalAlpha=Math.max(0,this.life); ctx.fillStyle=this.col; ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
}

/** GAME CONTROL **/
function startGame() {
    AudioSys.init();
    document.getElementById('start-screen').style.display = 'none';
    initMap();
    GAME.active = true;
    startWave();
    requestAnimationFrame(gameLoop);
}

function startWave() {
    GAME.enemiesToSpawn = [];
    let count = 5 + GAME.wave * 2;
    for(let i=0; i<count; i++) {
        let type = 'normal';
        if (GAME.wave > 1 && i % 4 === 0) type = 'swarm';
        if (GAME.wave > 2 && i % 6 === 0) type = 'tank';
        if (GAME.wave % 5 === 0 && i === count-1) type = 'boss';
        GAME.enemiesToSpawn.push(type);
    }
    GAME.spawnTimer = 60;
}

function gameLoop() {
    if (!GAME.active || GAME.gameOver) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // -- DRAW LAYERS (Restored Styles) --
    GAME.bloodStains = GAME.bloodStains.filter(b => b.life > 0); GAME.bloodStains.forEach(b => b.draw());

    for (let d of GAME.decorations) {
        if(d.type === 'tree') {
             ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.beginPath(); ctx.arc(d.x+5, d.y+5, d.r, 0, Math.PI*2); ctx.fill();
             ctx.fillStyle = '#166534'; ctx.beginPath(); ctx.arc(d.x, d.y, d.r, 0, Math.PI*2); ctx.fill();
             ctx.fillStyle = '#15803d'; ctx.beginPath(); ctx.arc(d.x, d.y, d.r*0.7, 0, Math.PI*2); ctx.fill();
        } else {
             ctx.fillStyle = '#9ca3af'; ctx.beginPath(); ctx.arc(d.x, d.y, d.r*0.6, 0, Math.PI*2); ctx.fill();
        }
    }

    // Road
    ctx.strokeStyle = '#a8a29e'; ctx.lineWidth = 46; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    ctx.beginPath(); ctx.moveTo(GAME.path[0].x, GAME.path[0].y); for(let p of GAME.path) ctx.lineTo(p.x, p.y); ctx.stroke();
    ctx.strokeStyle = '#e7e5e4'; ctx.lineWidth = 40; ctx.stroke();

    // Cave & Base
    let start = GAME.path[0];
    ctx.fillStyle = '#1f2937'; ctx.beginPath(); ctx.arc(start.x, start.y, 35, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(start.x, start.y, 25, 0, Math.PI*2); ctx.fill();

    let end = GAME.path[GAME.path.length-1];
    ctx.fillStyle = '#2563eb'; ctx.beginPath(); ctx.rect(end.x - 30, end.y - 30, 60, 60); ctx.fill();
    ctx.fillStyle = '#1e40af'; ctx.beginPath(); ctx.moveTo(end.x-35, end.y-30); ctx.lineTo(end.x, end.y-55); ctx.lineTo(end.x+35, end.y-30); ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font='24px Arial'; ctx.fillText('üè∞', end.x-14, end.y+10);

    // Slots
    for(let s of GAME.slots) {
        if(!s.occupied) {
            ctx.fillStyle = 'rgba(255,255,255,0.15)'; ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth=2;
            ctx.beginPath(); ctx.arc(s.x,s.y,12,0,Math.PI*2); ctx.fill(); ctx.stroke();
        }
    }

    // Entities
    GAME.towers.forEach(t => { t.update(); t.draw(); });
    
    // -- FIXED SPAWN LOGIC --
    if (GAME.enemiesToSpawn.length > 0) {
        GAME.spawnTimer--;
        if (GAME.spawnTimer <= 0) {
            GAME.enemies.push(new Enemy(GAME.enemiesToSpawn.shift()));
            GAME.spawnTimer = GAME.wave < 5 ? 50 : 30;
        }
    } else if (GAME.enemies.length === 0) {
        // Break between waves
        if(GAME.waveTimer > 0) {
            GAME.waveDelayTicker--;
            if(GAME.waveDelayTicker <= 0) {
                GAME.waveTimer--;
                GAME.waveDelayTicker = 60;
                document.getElementById('wave-timer').innerText = `Qu√°i t·ªõi: ${GAME.waveTimer}s`;
            }
        } else {
            GAME.wave++; updateUI(); startWave(); GAME.waveTimer=5;
        }
    }

    GAME.enemies.sort((a,b)=>a.y-b.y);
    GAME.enemies = GAME.enemies.filter(e => { e.update(); e.draw(); return e.hp > 0; });

    if(GAME.soldierCooldown > 0) GAME.soldierCooldown -= 1/60;
    GAME.soldiers = GAME.soldiers.filter(s => { s.update(); s.draw(); return s.hp > 0; });

    GAME.projectiles = GAME.projectiles.filter(p => { p.update(); p.draw(); return p.active; });
    GAME.particles = GAME.particles.filter(p => { p.update(); p.draw(); return p.life>0; });

    // Preview
    if (GAME.selection && GAME.selection !== 'soldier' && !GAME.selectedTower) {
        ctx.beginPath(); ctx.arc(mousePos.x, mousePos.y, TOWERS_BASE[GAME.selection].range, 0, Math.PI*2);
        ctx.strokeStyle = 'rgba(255,255,255,0.5)'; ctx.stroke();
    }
    requestAnimationFrame(gameLoop);
}

/** INTERACTION & UI **/
canvas.addEventListener('mousemove', e => mousePos = {x: e.clientX, y: e.clientY});
canvas.addEventListener('click', e => {
    if (!GAME.active) return;
    const x = e.clientX; const y = e.clientY;

    let clickedTower = null;
    for(let t of GAME.towers) { if(Math.hypot(t.x - x, t.y - y) < 30) { clickedTower = t; break; } }

    if (clickedTower) {
        GAME.selectedTower = clickedTower; GAME.selection = null;
        showInspector(clickedTower); return;
    }
    if (!clickedTower && GAME.selectedTower) closeInspector();

    if (GAME.selection === 'soldier') {
        if(GAME.soldierCooldown <= 0) {
            GAME.soldiers.push(new Soldier(x, y)); GAME.soldierCooldown = GAME.soldierMaxCooldown;
            AudioSys.playBuild(); resetSelection();
        }
    } else if (GAME.selection) {
        let nearest = GAME.slots.find(s => !s.occupied && Math.hypot(s.x-x, s.y-y) < 30);
        if (nearest) {
            let cost = TOWERS_BASE[GAME.selection].cost;
            if (GAME.gold >= cost) {
                GAME.gold -= cost;
                let t = new Tower(nearest.x, nearest.y, GAME.selection);
                GAME.towers.push(t); nearest.occupied = true; nearest.towerRef = t;
                AudioSys.playBuild(); updateUI(); resetSelection();
            } else { showFloatText("Thi·∫øu ti·ªÅn!", x, y, '#ef4444'); }
        }
    }
});

function toggleMenu() {
    document.getElementById('menu-container').classList.toggle('collapsed');
    let btn = document.querySelector('.toggle-btn');
    btn.innerText = btn.innerText.includes('‚ñº') ? '‚ñ≤ M·ªü Menu ‚ñ≤' : '‚ñº Menu X√¢y D·ª±ng ‚ñº';
}
function selectTower(type) { closeInspector(); if(GAME.selection===type) resetSelection(); else { resetSelection(); GAME.selection=type; document.getElementById('btn-'+type).classList.add('selected'); } }
function selectSoldier() { if(GAME.soldierCooldown>0) return; closeInspector(); if(GAME.selection==='soldier') resetSelection(); else { resetSelection(); GAME.selection='soldier'; document.getElementById('btn-soldier').classList.add('selected'); } }
function resetSelection() { GAME.selection=null; document.querySelectorAll('.tower-btn').forEach(b => b.classList.remove('selected')); }
function showInspector(tower) {
    document.getElementById('tower-inspector').style.display='block';
    document.getElementById('insp-name').innerText=`${TOWERS_BASE[tower.type].name} (C·∫•p ${tower.level})`;
    document.getElementById('insp-dmg').innerText=Math.floor(tower.damage);
    document.getElementById('insp-spd').innerText=(tower.rate/60).toFixed(1)+'s';
    document.getElementById('insp-rng').innerText=Math.floor(tower.range);
    let cost=tower.getUpgradeCost(); document.getElementById('upgrade-cost').innerText=cost+'$';
    document.getElementById('sell-price').innerText=tower.getSellPrice()+'$';
}
function closeInspector() { GAME.selectedTower=null; document.getElementById('tower-inspector').style.display='none'; }
function upgradeSelectedTower() {
    if(!GAME.selectedTower) return; let cost=GAME.selectedTower.getUpgradeCost();
    if(GAME.gold>=cost) { GAME.gold-=cost; GAME.selectedTower.upgrade(); updateUI(); showInspector(GAME.selectedTower); showFloatText("N√¢ng c·∫•p!", GAME.selectedTower.x, GAME.selectedTower.y-20, '#facc15'); }
    else showFloatText("Kh√¥ng ƒë·ªß ti·ªÅn!", GAME.selectedTower.x, GAME.selectedTower.y-20, '#ef4444');
}
function sellSelectedTower() {
    if(!GAME.selectedTower) return; let refund=GAME.selectedTower.getSellPrice(); GAME.gold+=refund; AudioSys.playSell();
    GAME.towers=GAME.towers.filter(t=>t!==GAME.selectedTower);
    let slot=GAME.slots.find(s=>Math.hypot(s.x-GAME.selectedTower.x, s.y-GAME.selectedTower.y)<5); if(slot) { slot.occupied=false; }
    showFloatText("+"+refund+"$", GAME.selectedTower.x, GAME.selectedTower.y-20, '#fbbf24'); closeInspector(); updateUI();
}
function updateUI() {
    document.getElementById('lives').innerText=GAME.lives; document.getElementById('gold').innerText=GAME.gold; document.getElementById('wave').innerText=GAME.wave;
    ['archer','cannon','mage','tesla'].forEach(t=> { let b=document.getElementById('btn-'+t); if(GAME.gold<TOWERS_BASE[t].cost) b.classList.add('disabled'); else b.classList.remove('disabled'); });
    let sBtn=document.getElementById('btn-soldier'); if(GAME.soldierCooldown>0) { sBtn.classList.add('disabled'); sBtn.querySelector('.cost').innerText=Math.ceil(GAME.soldierCooldown)+'s'; } else { sBtn.classList.remove('disabled'); sBtn.querySelector('.cost').innerText='Free'; }
}
function showFloatText(txt, x, y, col) {
    let el=document.createElement('div'); el.className='floating-text'; el.innerText=txt; el.style.left=x+'px'; el.style.top=y+'px'; el.style.color=col;
    document.getElementById('floating-text-container').appendChild(el); setTimeout(()=>el.remove(), 1000);
}
function endGame() { GAME.gameOver=true; document.getElementById('game-over-screen').style.display='flex'; document.getElementById('final-wave').innerText=GAME.wave; }
</script>
</body>
</html>